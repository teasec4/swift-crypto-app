# –°–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –∏ –∞—Å—Å–µ—Ç–æ–≤

## –ê—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–∞: Remote ‚Üî Local Sync

```
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ SUPABASE (Remote)                                           ‚îÇ
‚îÇ - –ê—É—Ç–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ü–∏—è                                            ‚îÇ
‚îÇ - Session management                                        ‚îÇ
‚îÇ - –ò—Å—Ç–æ—á–Ω–∏–∫ –∏—Å—Ç–∏–Ω—ã –¥–ª—è –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏–∏                           ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¨‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
             ‚îÇ (client.auth.currentUser)
             ‚ñº
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ LOCAL DB (SwiftData)                                        ‚îÇ
‚îÇ - UserEntity (–ø–æ email)                                     ‚îÇ
‚îÇ - UserAsset (–ø—Ä–∏–≤—è–∑–∞–Ω—ã –∫ UserEntity)                        ‚îÇ
‚îÇ - –†–∞–±–æ—Ç–∞–µ—Ç –û–§–õ–ê–ô–ù                                           ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
```

## Flow: –ó–∞–ø—É—Å–∫ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è

```
1. App.onAppear()
   ‚îú‚îÄ authVM.restoreUserFromDatabase(context)
   ‚îÇ  ‚îú‚îÄ –ü—Ä–æ–≤–µ—Ä—è–µ—Ç: client.auth.currentUser (–µ—Å—Ç—å –ª–∏ Supabase session?)
   ‚îÇ  ‚îú‚îÄ getOrCreateLocalUser()
   ‚îÇ  ‚îÇ  ‚îú‚îÄ –ò—â–µ—Ç –≤ SwiftData –ø–æ email (—É–Ω–∏–∫–∞–ª—å–Ω—ã–π –∫–ª—é—á)
   ‚îÇ  ‚îÇ  ‚îú‚îÄ –ï—Å–ª–∏ –Ω–∞–π–¥–µ–Ω ‚Üí –≤–æ–∑–≤—Ä–∞—â–∞–µ—Ç —Å—É—â–µ—Å—Ç–≤—É—é—â–µ–≥–æ
   ‚îÇ  ‚îÇ  ‚îî‚îÄ –ï—Å–ª–∏ –ù–ï–¢ ‚Üí —Å–æ–∑–¥–∞—ë—Ç –Ω–æ–≤–æ–≥–æ –∏ —Å–æ—Ö—Ä–∞–Ω—è–µ—Ç
   ‚îÇ  ‚îî‚îÄ authVM.user = localUser
   ‚îÇ
2. ContentView.onAppear()
   ‚îú‚îÄ assetsViewModel.currentUser = authVM.user
   ‚îú‚îÄ assetsViewModel.loadAssets(context)
   ‚îÇ  ‚îú‚îÄ –ó–∞–≥—Ä—É–∂–∞–µ—Ç assets —á–µ—Ä–µ–∑ user.assets relationship
   ‚îÇ  ‚îî‚îÄ –û—Ç–æ–±—Ä–∞–∂–∞–µ—Ç –∏—Ö –≤ UI
   ‚îÇ
3. –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –≤–∏–¥–∏—Ç —Å–≤–æ–∏ –∞—Å—Å–µ—Ç—ã
```

## Flow: –í—Ö–æ–¥ –≤ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ (Sign In)

```
1. –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –≤–≤–æ–¥–∏—Ç email + –ø–∞—Ä–æ–ª—å
   ‚ñº
2. authVM.signIn(email, password, context)
   ‚îú‚îÄ Supabase auth: try client.auth.signIn()
   ‚îú‚îÄ –°–æ–∑–¥–∞—ë—Ç –ª–æ–∫–∞–ª—å–Ω–æ–≥–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è:
   ‚îÇ  getOrCreateLocalUser(supabaseId, email, name, context)
   ‚îÇ  ‚îú‚îÄ –ò—â–µ—Ç –≤ SwiftData –ø–æ email
   ‚îÇ  ‚îú‚îÄ –ï—Å–ª–∏ –Ω–∞—à–ª–∏ ‚Üí return existing
   ‚îÇ  ‚îî‚îÄ –ï—Å–ª–∏ –Ω–µ—Ç ‚Üí create new + save
   ‚îú‚îÄ authVM.user = localUser
   ‚îÇ
3. ContentView.onChange(authVM.user) —Ç—Ä–∏–≥–≥–µ—Ä
   ‚îú‚îÄ assetsViewModel.currentUser = authVM.user
   ‚îú‚îÄ assetsViewModel.loadAssets(context)
   ‚îî‚îÄ UI –ø–æ–∫–∞–∑—ã–≤–∞–µ—Ç –∞—Å—Å–µ—Ç—ã –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
```

## Flow: –î–æ–±–∞–≤–ª–µ–Ω–∏–µ –∞—Å—Å–µ—Ç–∞

```
1. –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –Ω–∞–∂–∏–º–∞–µ—Ç "Add Asset"
   ‚ñº
2. AssetsView ‚Üí AddAssetFormView
   ‚îÇ
3. –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –≤–≤–æ–¥–∏—Ç –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ –∏ —Å–æ—Ö—Ä–∞–Ω—è–µ—Ç
   ‚îÇ
4. AddAssetViewModel.submit(context)
   ‚îú‚îÄ assetsViewModel.addAsset(coin, amount, context)
   ‚îÇ  ‚îú‚îÄ –ü—Ä–æ–≤–µ—Ä—è–µ—Ç, —á—Ç–æ currentUser —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω ‚úì
   ‚îÇ  ‚îú‚îÄ –°–æ–∑–¥–∞—ë—Ç UserAsset —Å user = currentUser
   ‚îÇ  ‚îú‚îÄ context.insert(newAsset)
   ‚îÇ  ‚îú‚îÄ user.assets.append(newAsset) ‚Üê –ø—Ä–∏–≤—è–∑–∫–∞!
   ‚îÇ  ‚îî‚îÄ context.save() ‚Üê —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ
   ‚îÇ
5. SwiftData —Å–æ—Ö—Ä–∞–Ω—è–µ—Ç –≤ –ë–î:
   UserEntity ‚îÄ‚îÄ(1:N)‚îÄ‚îÄ> UserAsset
   
6. assetsViewModel.assets –æ–±–Ω–æ–≤–ª—è–µ—Ç—Å—è
   ‚îÇ
7. UI –ø–µ—Ä–µ—Ä–∏—Å–æ–≤—ã–≤–∞–µ—Ç—Å—è
```

## Flow: –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ —Ü–µ–Ω –∞—Å—Å–µ—Ç–æ–≤

```
1. AssetsView.onAppear()
   ‚îî‚îÄ assetsViewModel.refreshAssetPrices(context)
       ‚îú‚îÄ –ü–æ–ª—É—á–∞–µ—Ç —Å–ø–∏—Å–æ–∫ coinID –∏–∑ assets
       ‚îú‚îÄ API call: repository.getSimplePrices(ids)
       ‚îú‚îÄ –û–±–Ω–æ–≤–ª—è–µ—Ç prices –ª–æ–∫–∞–ª—å–Ω–æ
       ‚îî‚îÄ context.save() ‚Üê —Å–æ—Ö—Ä–∞–Ω—è–µ—Ç –≤ –ë–î
```

## –ö–ª—é—á–µ–≤—ã–µ –º–æ–º–µ–Ω—Ç—ã

### ‚úÖ –ù–æ—Ä–º–∞–ª—å–Ω–∞—è –ø—Ä–∞–∫—Ç–∏–∫–∞?

–î–∞! –≠—Ç–æ –ø–∞—Ç—Ç–µ—Ä–Ω "Sync Remote with Local":

| –ê—Å–ø–µ–∫—Ç | Supabase | SwiftData |
|--------|----------|-----------|
| –†–æ–ª—å | –ò—Å—Ç–æ—á–Ω–∏–∫ –∏—Å—Ç–∏–Ω—ã –¥–ª—è –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏–∏ | –õ–æ–∫–∞–ª—å–Ω—ã–π –∫—ç—à + –¥–∞–Ω–Ω—ã–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è |
| –°–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏—è | client.auth.currentUser | getOrCreateLocalUser() |
| –°–≤—è–∑—å | Email = —É–Ω–∏–∫–∞–ª—å–Ω—ã–π –∫–ª—é—á | @Attribute(.unique) –Ω–∞ email |
| –û—Ñ–ª–∞–π–Ω | ‚ùå –ù–µ —Ä–∞–±–æ—Ç–∞–µ—Ç | ‚úÖ –†–∞–±–æ—Ç–∞–µ—Ç |

### –ó–∞—â–∏—Ç–∞ –æ—Ç –¥—É–±–ª–µ–π

```swift
@Model
final class UserEntity {
    @Attribute(.unique) var email: String  // ‚Üê –£–Ω–∏–∫–∞–ª—å–Ω—ã–π!
    ...
}
```

–ë–ª–∞–≥–æ–¥–∞—Ä—è `.unique`, –ø–æ–ø—ã—Ç–∫–∞ —Å–æ–∑–¥–∞—Ç—å –µ—â—ë –æ–¥–Ω–æ–≥–æ —é–∑–µ—Ä–∞ —Å —Ç–µ–º –∂–µ email –≤—ã–∑–æ–≤–µ—Ç –æ—à–∏–±–∫—É. –í `getOrCreateLocalUser()` –º—ã —Å–Ω–∞—á–∞–ª–∞ –∏—â–µ–º, –∏ —Ç–æ–ª—å–∫–æ –µ—Å–ª–∏ –Ω–µ –Ω–∞–π–¥—ë–º, —Å–æ–∑–¥–∞—ë–º.

### –ö–∞—Å–∫–∞–¥–Ω–æ–µ —É–¥–∞–ª–µ–Ω–∏–µ

```swift
@Relationship(deleteRule: .cascade, inverse: \UserAsset.user)
var assets: [UserAsset] = []
```

–ï—Å–ª–∏ —É–¥–∞–ª–∏—Ç—å UserEntity, –≤—Å–µ –µ–≥–æ –∞—Å—Å–µ—Ç—ã —Ç–æ–∂–µ —É–¥–∞–ª—è—Ç—Å—è –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏.

## –¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ

### –ü—Ä–æ–≤–µ—Ä—å –ª–æ–≥–∏:
```
üöÄ App started
‚úÖ Restored user from database: user@email.com
üë§ User changed: user@email.com
üì≤ Loading assets for: user@email.com
‚úÖ Loaded 3 assets via relationship for: user@email.com
```

### –°—Ü–µ–Ω–∞—Ä–∏–∏:
1. **–ü–µ—Ä–≤—ã–π –∑–∞–ø—É—Å–∫ (–Ω–æ–≤—ã–π –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å)**
   - Supabase: –µ—Å—Ç—å —Å–µ—Å—Å–∏—è
   - SwiftData: —é–∑–µ—Ä –Ω–µ –Ω–∞–π–¥–µ–Ω
   - –†–µ–∑—É–ª—å—Ç–∞—Ç: —Å–æ–∑–¥–∞—ë—Ç—Å—è –Ω–æ–≤—ã–π —é–∑–µ—Ä, –∞—Å—Å–µ—Ç—ã –ø—É—Å—Ç—ã–µ
   
2. **–ü–æ–≤—Ç–æ—Ä–Ω—ã–π –∑–∞–ø—É—Å–∫ (—Å—Ç–∞—Ä—ã–π –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å)**
   - Supabase: –µ—Å—Ç—å —Å–µ—Å—Å–∏—è
   - SwiftData: —é–∑–µ—Ä –Ω–∞–π–¥–µ–Ω + –µ–≥–æ –∞—Å—Å–µ—Ç—ã
   - –†–µ–∑—É–ª—å—Ç–∞—Ç: –≤—Å—ë –∑–∞–≥—Ä—É–∂–∞–µ—Ç—Å—è –∏–∑ –ë–î
   
3. **–í—ã—Ö–æ–¥ –∏ –≤—Ö–æ–¥**
   - SignOut: —É–¥–∞–ª—è–µ—Ç session + authVM.user = nil
   - SignIn: –∑–∞–Ω–æ–≤–æ —Å–æ–∑–¥–∞—ë—Ç –ª–æ–∫–∞–ª—å–Ω–æ–≥–æ —é–∑–µ—Ä–∞ –∏ –∑–∞–≥—Ä—É–∂–∞–µ—Ç –µ–≥–æ –∞—Å—Å–µ—Ç—ã
