name: iOS Unit Tests

on:
  push:
    branches: [ main ]
  pull_request:
    branches: [ main ]

jobs:
  test:
    runs-on: macos-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Set up Xcode
        uses: maxim-lobanov/setup-xcode@v1
        with:
          # âš™ï¸ Ð¼Ð¾Ð¶Ð½Ð¾ Ð¾ÑÑ‚Ð°Ð²Ð¸Ñ‚ÑŒ Ñ‚Ð²Ð¾ÑŽ Ð²ÐµÑ€ÑÐ¸ÑŽ, Ð½Ð¾ CI Ð½Ðµ Ð²ÑÐµÐ³Ð´Ð° Ð¸Ð¼ÐµÐµÑ‚ 26.0.1
          # Ð¿Ð¾Ð¿Ñ€Ð¾Ð±ÑƒÐµÐ¼ '16.0' Ð´Ð»Ñ ÑÑ‚Ð°Ð±Ð¸Ð»ÑŒÐ½Ð¾ÑÑ‚Ð¸
          xcode-version: '16.0'

      - name: Debug environment
        run: |
          echo "ðŸ“¦ Xcode version:"
          xcodebuild -version
          echo "ðŸ§± Available SDKs:"
          xcodebuild -showsdks
          echo "ðŸ“± Available Simulators:"
          xcrun simctl list devices available

      - name: Get available simulator
        id: find-sim
        run: |
          device=$(xcrun simctl list devices available | grep -m1 "iPhone" | sed -E 's/.*\(([-A-F0-9]+)\).*/\1/')
          echo "device=$device" >> $GITHUB_OUTPUT
          echo "Using simulator UDID: $device"

      - name: Build and run tests
        run: |
          xcodebuild \
            -project CryptoAsyncAwait.xcodeproj \
            -scheme CryptoAsyncAwait \
            -destination "id=${{ steps.find-sim.outputs.device }}" \
            clean test \
            CODE_SIGN_IDENTITY="" CODE_SIGNING_REQUIRED=NO
