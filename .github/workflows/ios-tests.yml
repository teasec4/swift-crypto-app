name: iOS Unit Tests

on:
  push:
    branches: [ main ]
  pull_request:
    branches: [ main ]

jobs:
  test:
    runs-on: macos-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Set up Xcode
        uses: maxim-lobanov/setup-xcode@v1
        with:
          # ⚙️ можно оставить твою версию, но CI не всегда имеет 26.0.1
          # попробуем '16.0' для стабильности
          xcode-version: '16.0'

      - name: Debug environment
        run: |
          echo "📦 Xcode version:"
          xcodebuild -version
          echo "🧱 Available SDKs:"
          xcodebuild -showsdks
          echo "📱 Available Simulators:"
          xcrun simctl list devices available

      - name: Get available simulator
        id: find-sim
        run: |
          device=$(xcrun simctl list devices available | grep -m1 "iPhone" | sed -E 's/.*\(([-A-F0-9]+)\).*/\1/')
          echo "device=$device" >> $GITHUB_OUTPUT
          echo "Using simulator UDID: $device"

      - name: Build and run tests
        run: |
          xcodebuild \
            -project CryptoAsyncAwait.xcodeproj \
            -scheme CryptoAsyncAwait \
            -destination "id=${{ steps.find-sim.outputs.device }}" \
            clean test \
            CODE_SIGN_IDENTITY="" CODE_SIGNING_REQUIRED=NO
