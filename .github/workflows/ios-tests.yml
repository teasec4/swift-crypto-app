name: iOS Unit Tests

on:
  push:
    branches: [ main ]
  pull_request:
    branches: [ main ]

jobs:
  test:
    runs-on: macos-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Set up Xcode
        uses: maxim-lobanov/setup-xcode@v1
        with:
          # ÑÑ‚Ð°Ð±Ð¸Ð»ÑŒÐ½Ð°Ñ Ð²ÐµÑ€ÑÐ¸Ñ Ñ Ð¿Ð¾Ð´Ð´ÐµÑ€Ð¶ÐºÐ¾Ð¹ iOS 17.x / 18.x
          xcode-version: '15.4'

      # ðŸ‘‡ ÐÐ²Ñ‚Ð¾Ð¼Ð°Ñ‚Ð¸Ñ‡ÐµÑÐºÐ¸ Ð²Ñ‹Ð±Ð¸Ñ€Ð°ÐµÐ¼ Ð¿ÐµÑ€Ð²Ñ‹Ð¹ Ð´Ð¾ÑÑ‚ÑƒÐ¿Ð½Ñ‹Ð¹ iPhone ÑÐ¸Ð¼ÑƒÐ»ÑÑ‚Ð¾Ñ€
      - name: Get available simulator
        id: find-sim
        run: |
          device=$(xcrun simctl list devices available | grep -m1 "iPhone" | sed -E 's/.*\(([-A-F0-9]+)\).*/\1/')
          echo "device=$device" >> $GITHUB_OUTPUT
          echo "Using simulator UDID: $device"

      - name: Build and run tests
        run: |
          xcodebuild \
            -project CryptoAsyncAwait.xcodeproj \
            -scheme CryptoAsyncAwait \
            -destination "id=${{ steps.find-sim.outputs.device }}" \
            clean test \
            CODE_SIGN_IDENTITY="" CODE_SIGNING_REQUIRED=NO
